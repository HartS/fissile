FROM {{ index . "base_image" }}

MAINTAINER hcf@hpe.com

{{ with $context := . }}
{{ with $role := index . "role" }}
{{ with $job := index $role.Jobs 0}}
LABEL "role"="{{ $role.Name }}" "release-version"="{{ $job.Release.Version }}" "version"="{{ index $context "image_version" }}"
{{ end }}
{{ end }}
{{ end }}

# Add packages
ADD packages /var/vcap/packages/

# Add job sources
ADD jobs /var/vcap/jobs-src/

# Add custom startup role scripts
ADD role-startup /opt/hcf/startup/

# Add run.sh
ADD run.sh /opt/hcf/

# Add license and/or notice file
{{ if or (.license) (.notice) }}
ADD {{.license}} {{.notice}} /opt/hcf/share/doc/
{{ end }}

ENTRYPOINT ["/opt/hcf/run.sh"]
