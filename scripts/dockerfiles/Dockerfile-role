FROM {{ index . "base_image" }}

MAINTAINER hcf@hpe.com

{{ with $context := . }}
{{ with $role := index . "role" }}
{{ with $job := index $role.Jobs 0}}
LABEL "role"="{{ $role.Name }}" "version"="{{ index $context "image_version" }}"
{{ end }}
{{ end }}
{{ end }}

# Add packages
{{ with $context := . }}
{{ with $role := index . "role" }}
{{ with $job := index $role.Jobs 0}}
{{ if not $job.Release.Dev }}
ADD packages /var/vcap/packages/
{{ end }}
{{ end }}
{{ end }}
{{ end }}

# Add job sources
ADD jobs /var/vcap/jobs-src/

# Add custom startup role scripts
ADD role-startup /opt/hcf/startup/

# Add run.sh
ADD run.sh /opt/hcf/

# Add license and/or notice file
{{ if gt (len .licenses) 0 }}
ADD {{ range $name, $_ := .licenses }}{{$name}} {{end}} /opt/hcf/share/doc/
{{ end }}

ENTRYPOINT ["/bin/bash", "/opt/hcf/run.sh"]
